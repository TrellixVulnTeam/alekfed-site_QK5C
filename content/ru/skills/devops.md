+++
title = "DevOps"
subtitle = "Общий опыт: 2 года"
tags = ['System']
date = 2020-03-27

# For description meta tag
description = "DevOps-инструменты, с которыми мне довелось поработать."

# Comment next line and the default banner wil be used.
banner = 'img/devops.svg'

+++

Мой опыт в области DevOps сосредоточен вокруг нужд компании, занимающейся разработкой платформы для интеграции с маркетплейсами Ozon, Wilberries, Tmall, Яндекс.Маркет и Goods.

# Kubernetes

Изначально инфраструктура компании базировалась на [Docker Compose](https://docs.docker.com/compose/)/[Docker Swarm](https://docs.docker.com/engine/swarm/), но в определённый момент появились основания для перевода её на Kubernetes. Есть опыт разворачивания кластеров с использованием [Kubespray](https://kubespray.io/) и [K3s](https://k3s.io/).

С появлением кластера у нас возник ряд проблем, в частности, с локальной разработкой. Я пробовал организовать её на основе локальных миникластеров ([kind](https://kind.sigs.k8s.io/), [minikube](https://minikube.sigs.k8s.io/docs/)) с утилитами вроде [Tilt](https://tilt.dev/) и [Skaffold](https://skaffold.dev/), но, в итоге, по ряду причин вернулся к Compose.

В то же время, упаковка приложений в [Helm-чарты](https://helm.sh/) в некоторой степени упростила управление ими в облаке. Для решения вопроса воспроизводимости конфигурации кластера на уровне приложений я пробовал [Helmfile](https://github.com/roboll/helmfile) и [провайдером Helm к Terraform](https://registry.terraform.io/providers/hashicorp/helm/latest/docs), и остановился на последнем.

# CI/CD

В области CI/CD мой опыт ограничен [GitLab](https://docs.gitlab.com/ee/ci/) и [Drone](https://www.drone.io/). Последним я заинтересовался, когда обнаружил, что GitLab'овские воркеры могут без проблем выжирать по 10Гб ОЗУ на **один** воркер и надо было что-то с этим делать. Но в какой-то момент появилась возможность дёшево перенести GitLab на отдельный сервер с кучей ОЗУ, так что вариант с Drone утратил актуальность.

# FaaS

Возможность иметь сервер FaaS-сервис в собственном кластере открывает интересные архитектурные возможности. [OpenFaaS](https://www.openfaas.com/) оказался отличным вариантом, под который довольно просто писать функции. Правда, локально (без кластера) он разворачивается через раз, но внутренний сервер для разработки решил вопрос.

# Nix

Другая интересная идея, которой я занимаюсь последнее время — декларативно-конфигурируемые дистрибутивы Linux для использования их в качестве базовых систем, которые не (так) страшно обновлять. К таковым, на сегодняшний день, серьёзно можно отнести только [NixOS](https://nixos.org/) (не [Guix](https://guix.gnu.org/)). Я поддерживаю конфигурацию своей системы [в репозитории](https://git.sr.ht/~alekfed/nix-config/tree), но было бы интересно попробовать эту систему для более масштабных задач.

(см. также раздел по Linux в [системном администрировании](/ru/skills/linux_bsd))

___
# Иллюстрация

- Заглавная надпись: логотип [AWS](https://aws.amazon.com/). Я иногда ориентируюсь на их решения в области веб-сервисов, когда прорабатываю вопросы инфраструктуры. Жаль, что порой их цены оставляют желать лучшего.

- Визуализация инфраструктуры в виде «парящих коробок»: вероятно, я решил сделать что-то подобное просматривая страницы [ELK](https://www.elastic.co/what-is/elk-stack) и [Vault](https://www.hashicorp.com/products/vault). Логотипы возле слоёв говорят сами за себя: HCL-скриптами обеспечиваем конфигурации машин ([Terraform](https://www.terraform.io/)), плейбуками — конфигурации систем ([Ansible](https://www.ansible.com/)), ресурсами — кластеров ([Kubernetes](https://kubernetes.io/)), чартами — приложений ([Helm](https://helm.sh/)). Стоит отметить, что порой границы между слоями не такие уж и строгие: к примеру, как упоминалось выше, Terraform'овские HCL-скрипты вполне могут описывать и конфигурацию Kubernetes-кластеров на уровне Helm-чартов.

- Логотипы на слое Helm: чартами можно относительно безболезненно развернуть в кластере и маршрутизатор с автоматическим TLS ([Traefik](https://traefik.io/traefik/)), и хранилище секретов с авторотацией ключей ([Vault](https://www.hashicorp.com/products/vault)), и фичастую среду для контроля исходного кода ([GitLab](https://gitlab.com/)), и даже навертеть на всё метрики ([Prometheus](https://prometheus.io/)).
